{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "693b1ea8_aa989615",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 42,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "This class seems to be of central importance, so it would be nice to at least have unit tests for it.",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d3e019ba_6cf768b9",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 42,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-02T13:17:27Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "693b1ea8_aa989615",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1dfab837_678e26ba",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 51,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Maybe don\u0027t expose those as mutable to the outside? Use the same private `_` field as elsewhere?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6ce49db7_884453b7",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 51,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-02T13:17:27Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "1dfab837_678e26ba",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5672499c_acb6c262",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 78,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Why don\u0027t we call `updateEngine.allocateSpace()` before?\n\nSee: https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/os/UpdateEngine.java#553",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2e47ac4b_15a10311",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 78,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-02T13:17:27Z",
      "side": 1,
      "message": "Not required for streaming updates as updates are applied as they are downloaded. We might use this when we want to download updates over Tor later, but not required atm.",
      "parentUuid": "5672499c_acb6c262",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "887334d4_369b3d3d",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 82,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "It might be cleaner to let `fetchPayloadProperties` return them already in the format we\u0027ll need, so no last minute tweaks are needed here.",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9b30b5f5_906a48f5",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 82,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T09:32:22Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "887334d4_369b3d3d",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1f5ca551_9e5c583b",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 89,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "I\u0027d argue that this error case and the above would justify to log them above debug level, especially since debug isn\u0027t shown in release builds which we\u0027ll be using I guess.\n\nOtherwise, we\u0027ll have issues in production and have nothing in the log helping us to diagnose the issue.",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "69dbe67b_ee77938b",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 98,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Wow, nobody is allowed to, but they can pass raw files around, even in app\u0027s private folder.",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0a9e5e8c_79adfc23",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 101,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Do we get informed about the problem here in another way? Or is swallowing the exception here an issue? I guess returning false here already tells us that verification failed. It *may* make sense to pass the exception up and use it even in `FAILED_PREPARING_UPDATE` so we could later surface it in the UI. \n\nIn general, I\u0027d argue that we should never ever just use printStackTrace(), but properly log the exception. Here, this would be `Log.e(TAG, \"error verifying metadata: \", e)`.",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62c3c5d6_4e23b31a",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 109,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "If fetching fails, you return this. Maybe better to return `null` instead?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5e056e15_bd96b246",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 112,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Using `HttpURLConnection` might not enforce all the latest TLS security best practices. How much are we relying on what is returned here? What could an attacker do if they controlled the response?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9d1aa540_fd179eea",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 112,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T06:36:20Z",
      "side": 1,
      "message": "Switched to `HttpsURLConnection`",
      "parentUuid": "5e056e15_bd96b246",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d0c19b6b_28200837",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 117,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Comment still talks about `-1` while you do `-2`, why is this?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "604b1e73_33854dea",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 117,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T09:32:22Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d0c19b6b_28200837",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "991b7625_e0af7b0e",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 120,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "This may happen to flaky network, so maybe we\u0027d want to signal the worker to retry when a certain exception happens?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "91973546_aaf7d26b",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 120,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T06:36:20Z",
      "side": 1,
      "message": "We display a `Retry` button in UI on failures. I will add logic for auto-retry for workmanager.",
      "parentUuid": "991b7625_e0af7b0e",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4c485c6d_122ab12b",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 127,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2023-03-02T16:46:18Z",
      "side": 1,
      "message": "Is this function even used now? If so, for what?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d13ffa0e_77be96f2",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 127,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T06:36:20Z",
      "side": 1,
      "message": "This is being used to download `payload_metadata.bin` from `payload.bin`\u0027s header. Range request is somehow corrupting the file resulting in verification failure. We will debug and switch to it after workmanager and notification implementation is done to avoid keeping this open. Skipping doesn\u0027t takes a long time in this case as metadata is always in front unlike properties.",
      "parentUuid": "4c485c6d_122ab12b",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7971c9eb_ac2431d0",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 128,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "What\u0027s wrong with `context.openFileInput()`?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "96a304c6_a8656a41",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 128,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T09:32:22Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7971c9eb_ac2431d0",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "19a45707_9bdc13b0",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 135,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Why don\u0027t we use a range request here as well and then just read the entire thing without the complicated logic below?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "23e7ffad_89ed6f6d",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 135,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T06:36:20Z",
      "side": 1,
      "message": "This is being used to download `payload_metadata.bin` from `payload.bin`\u0027s header. Range request is somehow corrupting the file resulting in verification failure. We will debug and switch to it after workmanager and notification implementation is done to avoid keeping this open. Skipping doesn\u0027t takes a long time in this case as metadata is always in front unlike properties.",
      "parentUuid": "19a45707_9bdc13b0",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a1c085c6_ea1084e9",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 160,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "We swallow the exception and even return the file. What happens if the file got written to only partially? Would we want to abort before?\n\nI guess that the file doesn\u0027t get deleted here is fine as we keep overwriting the same one?\n\nMaybe returning `null` instead when we couldn\u0027t complete writing to the file would be better, or letting the exception bubble up, catching it elsewhere?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0679f23b_bbd661ab",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 167,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "This looks brittle. Maybe there\u0027s a more reliable way to turn their status into ours? Or we work directly on theirs?",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "786f03c4_04427ebc",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 167,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T06:36:20Z",
      "side": 1,
      "message": "We work directly on the status updates provided by the engine. Only 3 extra status are added by us that are at the bottom of the list. So this logic is safe.",
      "parentUuid": "0679f23b_bbd661ab",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "68ede6df_29e9247e",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 172,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Maybe use more speaking parameter names for both overridden methods?\n\nWhy can we ignore the return values the update engine throws at us here?\nThere\u0027s a long list of error constants defined here at: https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/os/UpdateEngine.java#58\n\nHow will we know that the update has failed or needs a reboot for example?\nEdit: Ah I think this all happens in `onStatusUpdate()`, right? Might be good to add some docs above in that case.",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "eb0f5e60_d0e26c25",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/manager/UpdateManagerImpl.kt",
        "patchSetId": 14
      },
      "lineNbr": 172,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-03T06:36:20Z",
      "side": 1,
      "message": "There are actually around 63 status that can be sent by update-engine here if you will check the header file. The java class only mirrors some of them but engine will send any regardless of that. As you say, the above method gives us status we care about. I will add a comment explaining that.\n\nhttps://cs.android.com/android/platform/superproject/+/master:system/update_engine/common/error_code.h",
      "parentUuid": "68ede6df_29e9247e",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "744555cd_d7da16cd",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/models/UpdateStatus.kt",
        "patchSetId": 14
      },
      "lineNbr": 33,
      "author": {
        "id": 1000003
      },
      "writtenOn": "2023-03-01T17:59:03Z",
      "side": 1,
      "message": "Is this already used somewhere? I couldn\u0027t find anything.\n\nIf the enum values are important, it might make sense to pass them in explicitly as an int field.",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c62bf645_d5530144",
        "filename": "app/src/main/java/org/calyxos/systemupdater/update/models/UpdateStatus.kt",
        "patchSetId": 14
      },
      "lineNbr": 33,
      "author": {
        "id": 1000065
      },
      "writtenOn": "2023-03-02T13:17:27Z",
      "side": 1,
      "message": "This is used in UI, sent by update-engine one update has been applied but device is pending for a reboot. We show a restart now button in that case.",
      "parentUuid": "744555cd_d7da16cd",
      "revId": "396ea093d93f4e621158757af59879364eb6d010",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    }
  ]
}